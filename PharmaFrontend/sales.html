<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Point of Sale (POS)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Layout Grid */
        .pos-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        
        .panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .panel h2 { margin-top: 0; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        
        /* Inputs & Buttons */
        select, input { width: 95%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; }
        
        .btn-add { background-color: #3498db; color: white; border: none; padding: 10px 20px; width: 100%; cursor: pointer; font-weight: bold; border-radius: 4px; }
        .btn-add:hover { background-color: #2980b9; }

        .btn-checkout { background-color: #27ae60; color: white; border: none; padding: 15px; width: 100%; cursor: pointer; font-size: 1.2em; font-weight: bold; border-radius: 4px; margin-top: 20px; }
        .btn-checkout:hover { background-color: #219150; }

        /* Cart Table */
        .cart-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .cart-table th { background: #ecf0f1; padding: 8px; text-align: left; }
        .cart-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .total-row { font-weight: bold; font-size: 1.2em; text-align: right; padding-top: 15px; }

        /* History Table */
        #historyTable { width: 100%; background: white; border-collapse: collapse; margin-top: 20px; }
        #historyTable th, #historyTable td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        #historyTable th { background-color: #8e44ad; color: white; }
    </style>
</head>
<body>

<div class="container">
    <a href="index.html" style="text-decoration: none; font-weight: bold; color: #555;">‚¨Ö Back to Dashboard</a>
    <h1 style="color: #2c3e50;">üõí Point of Sale Terminal</h1>

    <div class="pos-grid">
        
        <div class="panel" style="border-top: 5px solid #3498db;">
            <h2>1. Add Items</h2>
            
            <label><strong>Select Customer:</strong></label>
            <select id="custSelect"><option>Loading Customers...</option></select>
            
            <hr>

            <label><strong>Select Medication:</strong></label>
            <select id="medSelect"><option>Loading Medications...</option></select>
            
            <label><strong>Quantity:</strong></label>
            <input type="number" id="qtyInput" value="1" min="1">
            
            <button class="btn-add" onclick="addToCart()">‚¨á Add to Cart</button>
        </div>

        <div class="panel" style="border-top: 5px solid #27ae60;">
            <h2>2. Current Cart</h2>
            <table class="cart-table">
                <thead>
                    <tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th><th>Action</th></tr>
                </thead>
                <tbody id="cartBody">
                    </tbody>
            </table>
            
            <div class="total-row">Grand Total: <span id="grandTotal">$0.00</span></div>
            
            <button class="btn-checkout" onclick="processCheckout()">‚úÖ Complete Transaction</button>
        </div>
    </div>

    <h3>üìú Recent Sales History</h3>
    <table id="historyTable">
        <thead>
            <tr><th>Order ID</th><th>Customer</th><th>Date</th><th>Total Amount</th><th>Status</th></tr>
        </thead>
        <tbody id="historyBody"></tbody>
    </table>
</div>

<script>
    const API_BASE = "http://localhost:8080/api";
    let cart = []; // Local array to hold items before checkout
    let medicationsMap = {}; // Helper to store price/name info

    // ---INITIAL LOAD ---
    async function init() {
        await loadCustomers();
        await loadMedications();
        loadHistory();
    }

    async function loadCustomers() {
        const res = await fetch(`${API_BASE}/customers`);
        const data = await res.json();
        const select = document.getElementById('custSelect');
        select.innerHTML = data.map(c => `<option value="${c.customerId}">${c.name} (ID: ${c.customerId})</option>`).join('');
    }

    async function loadMedications() {
        const res = await fetch(`${API_BASE}/medications`);
        const data = await res.json();
        const select = document.getElementById('medSelect');
        select.innerHTML = '';
        
        data.forEach(m => {
            medicationsMap[m.ndcCode] = m; // Save for lookups
            select.innerHTML += `<option value="${m.ndcCode}">${m.name} - $${m.price} (Stock: ${m.quantityAvailable})</option>`;
        });
    }

    async function loadHistory() {
        // NOTE: Will need a GET endpoint for sales. 
        // If not made, this part might just stay empty or show a placeholder.
        // add @GetMapping to CustomerOrderController.
        try {
            const res = await fetch(`${API_BASE}/sales/history`); // You might need to create this endpoint
            if(res.ok) {
                const data = await res.json();
                document.getElementById('historyBody').innerHTML = data.map(o => 
                    `<tr><td>${o.orderId}</td><td>${o.customerId}</td><td>${o.orderDate}</td><td>$${o.totalCost}</td><td>${o.status}</td></tr>`
                ).join('');
            }
        } catch(e) { console.log("History endpoint not ready yet."); }
    }

    // --- CART LOGIC ---
    function addToCart() {
        const medId = document.getElementById('medSelect').value;
        const qty = parseInt(document.getElementById('qtyInput').value);
        const med = medicationsMap[medId];

        if(qty > med.quantityAvailable) {
            alert(`Error: Only ${med.quantityAvailable} in stock!`);
            return;
        }

        // Check if exists in cart
        const existing = cart.find(i => i.medicationId == medId);
        if(existing) {
            existing.quantity += qty;
        } else {
            cart.push({
                medicationId: medId,
                name: med.name,
                price: med.price,
                quantity: qty
            });
        }
        renderCart();
    }

    function renderCart() {
        const tbody = document.getElementById('cartBody');
        tbody.innerHTML = '';
        let total = 0;

        cart.forEach((item, index) => {
            const lineTotal = item.price * item.quantity;
            total += lineTotal;
            tbody.innerHTML += `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>$${item.price}</td>
                    <td>$${lineTotal.toFixed(2)}</td>
                    <td><button onclick="removeFromCart(${index})" style="color:red;border:none;background:none;cursor:pointer;">‚ùå</button></td>
                </tr>
            `;
        });

        document.getElementById('grandTotal').innerText = "$" + total.toFixed(2);
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
    }

    // --- CHECKOUT LOGIC ---
    async function processCheckout() {
        if(cart.length === 0) return alert("Cart is empty!");

        const payload = {
            customerId: document.getElementById('custSelect').value,
            items: cart.map(i => ({
                medicationId: i.medicationId,
                quantity: i.quantity
            }))
        };

        try {
            const res = await fetch(`${API_BASE}/sales/checkout`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            const text = await res.text();
            
            if(res.ok) {
                alert("‚úÖ Transaction Complete!\n" + text);
                cart = []; // Clear cart
                renderCart();
                loadMedications(); // Refresh stock levels
                // loadHistory(); // Refresh table
            } else {
                alert("‚ùå Transaction Failed:\n" + text);
            }
        } catch(e) {
            console.error(e);
            alert("Network Error");
        }
    }

    init();
</script>
</body>
</html>